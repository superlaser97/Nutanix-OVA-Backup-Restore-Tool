# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a bash-based Nutanix OVA Backup & Restore Tool that provides interactive scripts for backing up and restoring VMs from Nutanix Prism Central. The tool consists of several interconnected bash scripts that handle VM export, restore operations, and backup management.

## Core Architecture

### Main Scripts
- `scripts/export_menu.sh` - Export VMs to OVA backups with interactive selection
- `scripts/restore_menu.sh` - Bulk restore multiple VMs from backup points  
- `scripts/custom_restore.sh` - Single VM restore with custom configuration options
- `scripts/manage_restore_points.sh` - Manage existing backup restore points
- `scripts/setup_wizard.sh` - Initial configuration and credential setup

### Shared Library
- `scripts/ui_lib.sh` - Common UI/UX library providing standardized functions for:
  - API calls to Nutanix Prism Central v3 REST API
  - Progress tracking and menu systems
  - Credential management and validation
  - File operations and restore point handling

### Data Structure
```
restore-points/
└── vm-export-YYYY-MM-DD_HH-MM-SS/
    ├── vm_export_tasks.csv      # Export metadata
    ├── {vm_uuid}.ova           # VM backup files
    └── restore_tasks_*.csv     # Restore operation logs
```

## Development Commands

### Setup and Prerequisites
```bash
# Run setup wizard to configure credentials
./scripts/setup_wizard.sh

# Quick setup (non-interactive)
./scripts/setup_wizard.sh --quick

# Make all scripts executable
chmod +x scripts/*.sh
```

### Running the Tools
```bash
# Export VMs
./scripts/export_menu.sh

# Restore VMs (bulk)
./scripts/restore_menu.sh

# Custom VM restore
./scripts/custom_restore.sh

# Manage backups
./scripts/manage_restore_points.sh
```

### Testing API Connection
Scripts automatically test API connectivity, but you can manually test:
```bash
# Source credentials and test connection
source .nutanix_creds
curl -s -k -u "$USER:$PASS" -X POST "https://$PRISM/api/nutanix/v3/vms/list" -H 'Content-Type: application/json' -d '{"length":1}' | jq
```

## Key Configuration

### Credentials File (.nutanix_creds)
- **NEVER commit this file** - contains sensitive authentication data
- Auto-generated by `setup_wizard.sh` with 600 permissions
- Contains PRISM (IP/hostname), USER, and PASS variables

### Script Configuration
- `POLL_INTERVAL=3` - API status check frequency (seconds)
- `CHUNK_SIZE=100MB` - Upload chunk size for OVA files
- `ITEMS_PER_PAGE=15` - Menu pagination size
- Scripts use `restore-points/` directory for backup storage

## Important Notes

### Dependencies
All scripts require: `jq`, `curl`, `sha1sum`, and `bash 4.0+`

### API Integration
- Uses Nutanix Prism Central v3 REST API exclusively
- Handles VM operations (list, export, create), OVA management, and resource discovery
- All API calls go through the shared library's `api_call()` function in `ui_lib.sh:341`

### Error Handling
- Scripts use `set -euo pipefail` for strict error handling
- Shared library provides standardized error/success messaging
- Progress tracking maintains state across long-running operations

### UI/UX Standards
- All scripts use the shared UI library for consistent look and feel
- Color-coded output with icons (✅ success, ❌ error, ⚠️ warning, ℹ️ info)
- Standardized menu navigation and pagination

When modifying these scripts, maintain consistency with the existing UI patterns and ensure all changes use the shared library functions rather than implementing custom equivalents.